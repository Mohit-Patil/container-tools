#!/bin/bash
# =============================================================================
# AI CLI Tools Container Launcher
# Run from any directory to start the container with that directory mounted
# Creates one persistent container per project directory
# =============================================================================

set -e

IMAGE_NAME="ai-cli-tools:latest"

# Volumes for persistent auth (different tools use different locations)
CONFIG_VOLUME="ai-cli-config"
CLAUDE_VOLUME="ai-cli-claude"
CODEX_VOLUME="ai-cli-codex"
AIDER_VOLUME="ai-cli-aider"

# Use current directory as workspace
WORKSPACE_DIR="${1:-$(pwd)}"

# Generate container name and workspace path from project directory name
PROJECT_NAME=$(basename "$WORKSPACE_DIR")
PROJECT_NAME_SANITIZED=$(echo "$PROJECT_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g')
CONTAINER_NAME="ai-tools-${PROJECT_NAME_SANITIZED}"
CONTAINER_WORKSPACE="/home/devuser/${PROJECT_NAME}"

# Check if image exists
if ! docker image inspect "$IMAGE_NAME" &>/dev/null; then
    echo "Error: Docker image '$IMAGE_NAME' not found."
    echo "Please build it first: make build (from container-tools directory)"
    exit 1
fi

# Check if container exists
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    # Container exists - check if it's running
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        # Container is running - attach to it
        echo "Attaching to running container: $CONTAINER_NAME"
        exec docker exec -it "$CONTAINER_NAME" /bin/bash
    else
        # Container exists but stopped - start and attach
        echo "Starting existing container: $CONTAINER_NAME"
        docker start "$CONTAINER_NAME" >/dev/null
        exec docker exec -it "$CONTAINER_NAME" /bin/bash
    fi
else
    # Container doesn't exist - create it
    echo "Creating new container: $CONTAINER_NAME"
    echo "Workspace: $CONTAINER_WORKSPACE"
    # Create tmp subdirectory in claude volume with correct ownership (uid 1000 = devuser)
    docker run --rm -v "$CLAUDE_VOLUME":/vol alpine sh -c "mkdir -p /vol/.tmp && chown 1000:1000 /vol/.tmp" 2>/dev/null || true

    docker run -d \
        --name "$CONTAINER_NAME" \
        -v "$WORKSPACE_DIR":"$CONTAINER_WORKSPACE" \
        -v "$CONFIG_VOLUME":/home/devuser/.config \
        -v "$CLAUDE_VOLUME":/home/devuser/.claude \
        -v "$CODEX_VOLUME":/home/devuser/.codex \
        -v "$AIDER_VOLUME":/home/devuser/.aider \
        -v "$HOME/.gitconfig":/home/devuser/.gitconfig:ro \
        -v "$HOME/.ssh":/home/devuser/.ssh:ro \
        -w "$CONTAINER_WORKSPACE" \
        -e TERM=xterm-256color \
        -e HOST_PWD="$WORKSPACE_DIR" \
        -e CLAUDE_CONFIG_DIR=/home/devuser/.claude \
        -e CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 \
        -e TMPDIR=/home/devuser/.claude/.tmp \
        -p 3000:3000 \
        -p 4000:4000 \
        -p 5173:5173 \
        -p 5174:5174 \
        -p 8000:8000 \
        -p 8080:8080 \
        -p 8888:8888 \
        "$IMAGE_NAME" \
        tail -f /dev/null >/dev/null

    exec docker exec -it "$CONTAINER_NAME" /bin/bash
fi
